---
title: "Tensorflow Contributors"
author: "Augustina Ragwitz"
date: "July 17, 2017"
output: html_document
params:
  tf_path: "tensorflow"
  tf_sha: 'dd06643c'
  tf_out: '../data/tensorflow_gitlog.txt'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(readr)
library(reshape2)
library(zoo)
```

# Overview

This report serves two purposes. The original inspiration came from a request to better understand how Github was determining the contributor metrics it was reporting on it's website for the Tensorflow project. The second purpose is to test and refine participation metrics from other ongoing research efforts that could identify a high activity, growing project.

This notebook lives in Github: https://github.com/missaugustina/tensorflow_reports

# Commit History

Use the "git log" command to extract commit history. The "pretty" option allows the log output to be formatted.

```{r}
git_log_cmd <- paste('cd ', params$tf_path, 
                     '; git log ', params$tf_sha, 
                     ' --date=short --pretty=tformat:"%ad|%an" > ', params$tf_out, sep='')
system(git_log_cmd)

git_log_cmd
```


```{r}
tf_raw <- read.csv("data/tensorflow_gitlog.txt", header = FALSE, sep = "|", quote="",
                     col.names=c("git_log_date", "author"))

# add date formatting so these sort properly
tf_parsed_dates <- tf_raw %>% 
  mutate(commit_date=as.Date(git_log_date),
         commit_month=as.yearmon(commit_date)) %>% 
  select(commit_date, commit_month, author)
```

# Gitlog Commit Authors by Month

## Summarize by Month

```{r}
# exclude July
tf_parsed <- tf_parsed_dates %>%  filter(commit_month < 'Jul 2017')

# commits per author
tf_commits_by_author <- tf_parsed %>% 
  group_by(commit_month, author) %>% 
  summarise(num_author_commits=n())

# authors per month
tf_authors <- tf_commits_by_author %>% 
  group_by(commit_month) %>% 
  summarise(num_authors=n())

# commits per month
tf_commits_by_month <- tf_parsed %>% group_by(commit_month) %>% 
  summarise(num_commits=n())

# merge authors and commits per month
tf_authors_commits = merge(tf_authors, tf_commits_by_month, by=c("commit_month"))

# merge authors + commits per month with commits per author
tf_commits_by_author <- merge(tf_commits_by_author, tf_authors_commits, by=c("commit_month"))

# Calculate commits per author percent and log
# the rounded log is used for frequency buckets 
tf_commits_by_author <- tf_commits_by_author %>% 
  mutate(commits_pct = num_author_commits/num_commits,
         author_commits_log = round(log(num_author_commits)))

# Calculate number of months the author shows up in
tf_commits_by_author <- tf_commits_by_author %>%
  group_by(author) %>%
  mutate(commits_months=n())

# determine min and max for each log bucket
tf_commits_by_author <- tf_commits_by_author %>% 
  group_by(author_commits_log) %>%
  mutate(commits_min = min(num_author_commits), 
         commits_max = max(num_author_commits))

# clean up
rm(tf_authors, tf_commits_by_month)
```

## Summarize by Author

```{r}
# remove the "tensorflow bot"
tf_commits_by_author_nobot <- tf_commits_by_author %>% filter(author != "A. Unique TensorFlower")

tf_commits_by_author_summary <- tf_commits_by_author_nobot %>%
  group_by(author, author_commits_log) %>%
  summarise(
    commit_freq = n(),# Months Pattern was Observed
    commits_months = first(commits_months), 
    commit_freq_pct = round(commit_freq/commits_months, 2), # proportion of months pattern was observed
    author_commits_min = min(num_author_commits),
    author_commits_max = max(num_author_commits),
    commits_min = first(commits_min), 
    commits_max = first(commits_max)) %>%
  group_by(author) %>%
  mutate(
    freq_bins = n(), # number of months with different patterns
    freq_bins_pct = round(freq_bins/commits_months, 2)) # proportion of months w/ same patterns
# ex: 5 months -> commits log = 1, 1, 2, 3, 2 -> frequency = 1:2, 2:2, 3:1
# commit_freq_pct: 1:2/5, 2:2/5, 3:1/5 <- out of 5 months how often that commit log was observed
# freq_bins_pct: 3/5 months share the same commit log
```

## Unique Authors Total

Further down, Github reports the total "contributors" is 995. The discrepancy can be explained by Gitub's ability to normalize committers by Github login. If the same person commits from a different location with different author settings in their git config, they will have a different name in the commit log. Github can associate that person with a user but we cannot just from the commit log.

Therefore, we report a higher number of unique users than Github reports which explains this discrepancy (see below for more detail).

```{r}
# authors stats
tf_authors_total <- tf_parsed_dates %>% 
  group_by(author) %>% 
  summarise(commits=n())


total_authors <- nrow(tf_authors_total)

paste("Total Authors in Git Log:", total_authors)

paste("Difference from Github:", total_authors - 995)
```

## Unique Authors per Month

The number of unique authors has grown steadily per month. March 2017 shows a spike, so it could be interesting to see if this is due to the author/login discrepancy in the commit log or if this is real, and some other event happened to cause it.

```{r}
ggplot(data = tf_authors_commits, aes(x = factor(commit_month))) +
  geom_point(aes(y = num_authors, color="Authors"), group=1) +
  geom_line(aes(y = num_authors, color="Authors"), group=1) +
  ylab("Count") +
  xlab("Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Unique Authors vs Total Commits per Month

Overall in the Tensorflow project, the number of authors and commits are not only increasing but appear to be correlated. We'll explore that correlation further, but logically one can assume that more authors means more commits.

```{r}
ggplot(data = tf_authors_commits, aes(x = factor(commit_month))) +
  geom_point(aes(y = num_authors*5, color="Authors (scaled)"), group=1) +
  geom_line(aes(y = num_authors*5, color="Authors (scaled)"), group=1) +
  geom_point(aes(y = num_commits, color="Commits"), group=2) +
  geom_line(aes(y = num_commits, color="Commits"), group=2) +
  ylab("Count") +
  xlab("Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(data = tf_authors_commits, aes(x = num_commits, y = num_authors)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) +
  xlab("Commits") +
  ylab("Authors")
```

## Unique Authors vs Commits per Author per Month

How are commits per author distributed as the number of authors per month increases?

As the number of authors increases the proportion of commits becomes more evenly distributed, so we see a downward trend in percent of commits per author. Early on in the project, more authors had a higher proportion of the commits.

The second plot filters out the "A. Unique TensorFlower" bot which is clearly responsible for the largest proportion of commits as the number of authors increases.


```{r}
ggplot(data = tf_commits_by_author, aes(x = num_authors)) +
  geom_jitter(aes(y=num_author_commits, color="Commits")) +
  geom_jitter(aes(y=commits_pct * 1000, color="Commits %")) + # scaled for comparison
  geom_smooth(aes(y=commits_pct*1000), method="lm", se=FALSE) +
  xlab("Authors") +
  ylab("Commits per Author")

ggplot(data = tf_commits_by_author %>% filter(author != "A. Unique TensorFlower"), 
       aes(x = num_authors)) +
  geom_jitter(aes(y=num_author_commits, color="Commits")) +
  geom_jitter(aes(y=commits_pct * 1000, color="Commits %")) + # scaled for comparison
  geom_smooth(aes(y=commits_pct*1000), method="lm", se=FALSE) +
  xlab("Authors") +
  ylab("Commits per Author")

```

## Commits Per Author Frequency

What is the overall distribution for commits per author? How many commits do most authors make per month?

Commits per author were grouped into buckets based on the rounded natural log. The maximum value of that set is reported in the density plots below.

The highest per month commit frequency seen is 1-4 per month.

```{r}
ggplot(tf_commits_by_author_nobot, aes(x=factor(commits_max))) + 
  geom_density() +
  xlab("Commits per Author")

```

How many months have authors been contributing? Earlier analysis indicated that there were less authors in 2015 when the project started than there are in 2017.

The majority of Authors only have commits for 6 or less months.

```{r}
ggplot(tf_commits_by_author_nobot, aes(x=factor(commits_months))) + 
  geom_bar() +
  xlab("Author Months")
```

## Commits per Author Variability

Commit variability is a possible indicator of new committer proportion. As commit activity per author increases, so does the variability of commit activity from month to month. A project with a higher proportion of contributors with fewer months of commit history could be an indication of high developer interest. "Drive bys" are contributions from people do not continue to stay involved with the project, although they may continue to consume it. A high number of "drive bys" could indicate a strong developer user base.

Do authors make roughly the same number of commits each month?

The plot below shows what percentage of months the author comitted on have the same commit activity. In other words, for what percentage of months was the commit pattern observed?

This density plot would indicate that authors are fairly consistent in terms of their monthly commit activity. This consistency is likely due to the fact that the majority of authors have less than 6 months of commits.

```{r}
ggplot(tf_commits_by_author_summary, 
       aes(x=commit_freq_pct*100)) + 
  geom_density() +
  xlab("% of Months with Observed Commit Pattern")

```

The next plot looks at how much variation there was amongst commit patterns for authors for each month. What percentage of months share an observed commit pattern? If an author has the same commit pattern for 5 out of their 10 months, then 50% of that author's months share a commit pattern. The higher this percentage, the lower the overall variability.

This density plot would indicate that a majority of authors show 100% shared commit pattern. This consistency is likely due to the fact that the majority of authors have less than 6 months of commits.

```{r}
ggplot(tf_commits_by_author_summary, 
       aes(x=freq_bins_pct*100)) + 
  geom_density() +
  xlab("% of Months with Shared Commit Pattern")
```

Do authors who have contributed for more than 6 months show more variability in their commit patterns?

Authors with greater than 6 months of commit history represent about 7% of all authors (71/1068). The majority of authors only have one month of commit activity.

```{r}
ggplot(tf_commits_by_author_summary %>% filter(commits_months > 6), 
       aes(x=commit_freq_pct*100)) + 
  geom_bar() +
  xlab("% of Months with Observed Commit Pattern") +
  xlim(0,100)

ggplot(tf_commits_by_author_summary %>% filter(commits_months > 6), 
       aes(x=freq_bins_pct*100)) + 
  geom_bar() +
  xlab("% of Months with Shared Commit Pattern") +
  xlim(0,100)

```

## Commit Author Frequency vs Variability

Another indicator of project participation levels is the overall number of commits per author compared with commit frequency. Do authors that commit more frequently tend to have significantly more commits as well? In the Tensorflow project we see a small increase.

```{r}
ggplot(tf_commits_by_author_nobot %>% filter(commit_month > "Nov 2015"), 
       aes(x=factor(commits_months), y=round(commits_pct,2), colour=factor(commits_max))) + 
  geom_jitter() +
  xlab("# Months w/ Commits") +
  ylab("Commits per Author") +
  guides(colour=guide_legend(title="Commits"))

```


## Proportion of Commits per Author

Early on in the project there were less authors as is indicated by the higher proportion of commits. As the project has progressed however, the number of commits is more distributed.

The "bot" is the only author consistently responsible for a high proportion of the commit activity.

```{r}
ggplot(data = tf_commits_by_author, 
       aes(x = factor(commit_month), y = commits_pct, fill=author)) +
  geom_bar(stat="identity", position="stack") +
  ylab("Commits") +
  xlab("Month") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Excluded the "bot" account
ggplot(data = tf_commits_by_author %>% filter(author != "A. Unique TensorFlower"), 
       aes(x = factor(commit_month), y = commits_pct, fill=author)) +
  geom_bar(stat="identity", position="stack") +
  ylab("Commits") +
  xlab("Month") +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Does the maximum number of commits represent a smaller proportion of the commits over time? 

If project activity is gradually increasing, then a larger number of commits should gradually represent a smaller proportion of the overall commits per month.

```{r}
ggplot(tf_commits_by_author_nobot %>% filter(commit_month > "Nov 2015" & author_commits_log > 2), 
       aes(x=factor(commit_month), y=commits_pct, colour=factor(commits_max))) + 
  geom_jitter() +
  xlab("Month") +
  ylab("Commits per Author (%)") +
  guides(colour=guide_legend(title="Commits")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


## Compare Authors to the Pulse Report

How different are metrics in the Gitlog compared to what Github reports?

According to the Github Pulse Report, "Excluding merges, 155 authors have pushed 838 commits to master and 850 commits to all branches. On master, 2,554 files have changed and there have been 147,210 additions and 122,083 deletions."

![screenshot from Github Pulse Report - July 17, 2017](png/tf_github_pulse_2017-07-17.png)

```{r}
tf_pulse_check <- tf_parsed %>% filter(commit_date >= as.Date("2017-06-17"))

tf_pulse_check_authors <- tf_pulse_check %>% 
  group_by(commit_month, author) %>% 
  summarise(num_author_commits=n()) %>% 
  group_by(commit_month) %>% 
  summarise(num_authors=n())

total_authors_pulse_check <- sum(tf_pulse_check_authors$num_authors)
total_authors_pulse_check

155 - total_authors_pulse_check
```

## Git Log Analysis Conclusions

The key advantage of git log analysis is the lack of API overhead. The key disadvantage is the inability to easily consolidate authors. While the inability to consolidate authors may potentially misrepresent the distribution of commits, a growing project that regularly has new authors each month can potentially balance this out.

The analysis of Tensorflow's commit history suggests that a growing project will trend towards a smaller proportion of overall commits per month per author. Additionally, non-human users in such projects can be identified by a significantly higher proportion of commits than the other authors.

# Github Contributors

While commits can provide some insight into a project's overall growth and activity levels, not all contributions come in the form of commits. Github is an excellent resource for tracking this activity and they provide an archive of all public events going back to 2010. This section explores how the Github events activity for the tensorflow repository indicates a growing project.

The main page of the repo has a Contributors number but it's not clear how that is calculated. Their 2016 State of the Octoverse report (https://octoverse.github.com/) provided a defintion for the numbers in that report as: "unique contributors (users who pushed code, opened or commented on an issue or PR), unique code reviewers (users who commented on the changed files), and most forks".

Contributor Activity Described by Octoverse:

 * PushEvent
 * PullRequestReviewCommentEvent
 * PullRequestEvent
 * IssuesEvent
 * IssueCommentEvent
 * ForkEvent
 * CommitCommentEvent
 
 This section will explore these specific Github event types.

## Setting up the Github Events

This section outlines how the datasets were created.

1. Select events from the Github Archive going back to 2015:
https://bigquery.cloud.google.com/savedquery/306220071795:5c2975a4930245e184d1b87c40575821

2. Per Octoverse definition above, select the following event types:
https://bigquery.cloud.google.com/savedquery/306220071795:3c3f978b47324b44a954f026a79556d7

3. For purposes of this study, we are only interested in the 'tensorflow/tensorflow' repository.
https://bigquery.cloud.google.com/savedquery/306220071795:5d53bc77299c4a1195df258a04caa646

4. Export the resulting table to Cloud Storage (GBQ API will only return a limited dataset). Make public and get public link.

5. Download, extract, and read into R! (may need to add the ".csv" suffix)
https://storage.googleapis.com/open_source_community_metrics_exports/githubarchive_contributor_events_tf_repo_only.gz

```{r include=FALSE}
tf_gh_events <- read_csv('downloads/githubarchive_contributor_events_tf_repo_only.csv')

tf_gh_events <- tf_gh_events %>% 
  mutate(event_date = as.Date(created_at), event_month = as.yearmon(event_date),
         type=ifelse(type=="PullRequestReviewCommentEvent", "PRRCommentEvent", type))

tf_gh_events_types <- tf_gh_events %>%
  group_by(event_month, type, actor_login) %>% 
  summarise(num_events=n()) %>% 
  mutate(num_events_log=round(log(num_events + 1))) %>%
  group_by(event_month, type) %>%
  mutate(num_actors = n(), 
         num_actors_log=round(log(num_actors + 1)), 
         num_events_type = sum(num_events)) %>% 
  group_by(event_month) %>%
  mutate(total_events=sum(num_events))
```

## Octoverse Contributor Metrics

### Unique Contributors (users who pushed code, opened or commented on an issue or PR)
```{r}
tf_gh_contributors <- tf_gh_events_types %>% 
  filter(
    type == "PushEvent" | # Pushed Code
    type == "IssuesEvent" | type == "IssueCommentEvent" | # Opened or commented on Issue or PR
    type == "PullRequestEvent") %>% # Opened or commented on PR
  group_by(event_month, actor_login) %>%
  summarise(num_events=sum(num_events)) %>%
  group_by(event_month) %>%
  summarise(num_actors=n(), total_events=sum(num_events)) %>%
  mutate(metric="Contributors")

```

### Number of Forks
```{r}
tf_gh_forkers <- tf_gh_events_types %>% 
  filter(type == "ForkEvent") %>%
  group_by(event_month, actor_login) %>%
  summarise(num_events=sum(num_events)) %>%
  group_by(event_month) %>%
  summarise(num_actors=n(), total_events=sum(num_events)) %>%
  mutate(metric="Forkers")
```

### Unique Code Reviewers (users who commented on the changed files)
```{r}
tf_gh_reviewers <- tf_gh_events_types %>% 
  filter(type == "CommitCommentEvent" | type == "PRRCommentEvent") %>%
  group_by(event_month, actor_login) %>%
  summarise(num_events=sum(num_events)) %>%
  group_by(event_month) %>%
  summarise(num_actors=n(), total_events=sum(num_events)) %>%
  mutate(metric="Reviewers")
```

### Summary

Overall there is a trend towards growth in the 3 Actor categories proposed by the Octoverse report. Reviewers show the most growth. Forkers and Contributors appear to follow a very similar pattern. It would be interesting to see if this is indicative of a correlation.

```{r}
tf_gh_octoverse <- rbind(tf_gh_contributors, tf_gh_forkers, tf_gh_reviewers)
rm(tf_gh_forkers, tf_gh_contributors, tf_gh_reviewers)
```

```{r}
ggplot(data = tf_gh_octoverse, 
       aes(x = factor(event_month))) +
  geom_line(aes(colour=metric, y=num_actors, group=metric)) +
  geom_point(aes(colour=metric, y=num_actors, group=metric)) +
  ylab("Actors") +
  xlab("Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(data = tf_gh_octoverse, 
       aes(x = factor(event_month))) +
  geom_line(aes(colour=metric, y=num_actors, group=metric)) +
  geom_point(aes(colour=metric, y=num_actors, group=metric)) +
  ylab("Actors (log)") +
  xlab("Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_log10()

```


## Looking for Patterns

```{r}
tf_gh_events_type_per_actor <- tf_gh_events %>% 
  group_by(event_month, actor_login, type) %>% 
  summarise(num_actor_events=n()) %>%
  group_by(event_month, actor_login) %>%
  mutate(cnt_types_p_actor=n()) %>%
  group_by(event_month, type, cnt_types_p_actor) %>%
  mutate(num_actors_w_type_cnt=n())
```

```{r}
tf_gh_event_types_events_log <- tf_gh_events_types %>% 
  group_by(event_month, type, num_events_log) %>%
  summarise(actors_cnt=n(), events_min=min(num_events), events_max=max(num_events)) %>%
  group_by(type, num_events_log) %>% 
  mutate(num_events_log_freq = n()) %>%
  group_by(type) %>%
  mutate(max_num_events_log_freq = max(num_events_log_freq)) %>%
  filter(max_num_events_log_freq == num_events_log_freq) %>%
  group_by(type, num_events_log) %>%
  summarise(events_min=min(events_min), 
  events_max=max(events_max), 
  num_events_log_freq=first(num_events_log_freq))

tf_gh_event_types_actors_log <- tf_gh_events_types %>% 
  group_by(event_month, type, num_actors_log) %>%
  summarise(actors_min=min(num_actors), actors_max=max(num_actors)) %>%
  group_by(type, num_actors_log) %>% 
  mutate(num_actors_log_freq = n()) %>%
  group_by(type) %>%
  mutate(max_num_actors_log_freq = max(num_actors_log_freq)) %>%
  filter(max_num_actors_log_freq == num_actors_log_freq) %>%
  group_by(type, num_actors_log) %>%
  summarise(actors_min=min(actors_min), 
  actors_max=max(actors_max), 
  num_actors_log_freq=first(num_actors_log_freq))
  
```

### Event Type Contribution Frequency

What event types have the most unique actors?
What are the most frequent event types (per actor)?

```{r}
ggplot(data = tf_gh_event_types_actors_log, 
       aes(x = factor(num_actors_log), y = num_actors_log_freq, fill=type)) +
  geom_bar(stat="identity", position="dodge") +
  xlab("Actors (log)") +
  ylab("Freq as Max p/ Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(data = tf_gh_event_types_events_log, 
       aes(x = factor(num_events_log), y = num_events_log_freq, fill=type)) +
  geom_bar(stat="identity", position="dodge") +
  xlab("Events per Actor (log)") +
  ylab("Freq as Max p/ Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


### Event Type Diversity per Actor

How many actors contributed how many different event types for each event type? In other words are some event types more strongly associated with actors who contributed a wider range of event types?

For each month, what event type frequency had the most actors for each type?

```{r}
tf_gh_event_types_summary <- tf_gh_events_type_per_actor %>% 
  group_by(event_month, type) %>% 
  mutate(max_actors = max(num_actors_w_type_cnt)) %>%
  filter(num_actors_w_type_cnt == max_actors) %>%
  summarise(cnt_types_p_actor=first(cnt_types_p_actor),
            max_num_actors_w_type_cnt=first(num_actors_w_type_cnt))

tf_gh_event_types_summary_total <- tf_gh_event_types_summary %>%
  group_by(type, cnt_types_p_actor) %>%
  summarise(cnt_types_p_actor_freq=n()) %>%
  group_by(type) %>% mutate(max_type_freq=max(cnt_types_p_actor_freq))

ggplot(data = tf_gh_event_types_summary_total, 
       aes(x=factor(cnt_types_p_actor), y=cnt_types_p_actor_freq, fill=type)) +
  geom_bar(stat="identity", position="dodge") +
  xlab("Event Types p/ Actor") +
  ylab("Freq of Max p/ Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill=guide_legend(title="Event Types"))

```

### Events Contributed by Diverse Type Actors

How many events do actors who contribute in the top event type frequencies typically have per type? What's "normal" for active contributors?


# Events vs Commits

## Top Committers Event Types

What event types are strongly correlated with commit proportions per the analysis in this report?
(this will require matching using the Github API)

How about using Github's top committers list?

## Event Type Actors vs Top Committers

How many top actors are missed by only looking at top committers? Are top committers missing from any of the top event types?
